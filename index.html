<script>
  let step = 0;
  let emailTopic = "";
  let recipientName = "";
  let recipientEmail = "";

  const chatLog = document.getElementById("chatLog");
  const chatInput = document.getElementById("chatInput");

  window.onload = () => {
    appendBot("Hi! Who is the email for? (Full name)");
  };

  function appendBot(text) {
    chatLog.innerHTML += `<p class="bot"><strong>Bot:</strong> ${text}</p>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function appendUser(text) {
    chatLog.innerHTML += `<p class="user"><strong>You:</strong> ${text}</p>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  async function handleChat() {
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;

    appendUser(userMessage);
    chatInput.value = "";

    if (step === 0) {
      recipientName = userMessage;
      appendBot("What should the email be about?");
      step++;
    } else if (step === 1) {
      emailTopic = userMessage;
      appendBot("What is the recipient's email address?");
      step++;
    } else if (step === 2) {
      recipientEmail = userMessage;
      appendBot("Generating your email...");

      try {
        const response = await fetch("https://eohvq9npo15bpwz.m.pipedream.net", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: emailTopic,
            name: recipientName,
            email: recipientEmail
          })
        });

        const data = await response.json();
        console.log("Pipedream response:", data);

        if (data && data.emailBody) {
          appendBot("Here's your email draft:");
          appendBot(`<i>${data.emailBody}</i>`);
          appendBot("Would you like me to send it? (yes/no)");
          step++;
        } else {
          appendBot("⚠️ I couldn’t generate the email. Please try again.");
        }

      } catch (err) {
        console.error("Fetch failed:", err);
        appendBot("⚠️ There was an error connecting to the AI. Please try again.");
      }

    } else if (step === 3) {
      if (userMessage.toLowerCase().includes("yes")) {
        appendBot("✅ Email sent!");
      } else {
        appendBot("No problem! Let me know if you'd like to revise or resend.");
      }
      step = 4;
    }
  }
</script>

