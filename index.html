<!DOCTYPE html>
<html>
  <head>
    <title>AI Email Chatbot</title>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 40px;
        background-color: #f5f5f5;
      }
      #chatBox {
        max-width: 600px;
        margin: auto;
        padding: 20px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      #chatLog {
        min-height: 200px;
        margin-bottom: 10px;
      }
      .bot {
        text-align: left;
        margin: 6px 0;
      }
      .user {
        text-align: right;
        margin: 6px 0;
      }
      #chatInput {
        width: 80%;
        padding: 8px;
      }
      #sendBtn {
        width: 18%;
        padding: 8px;
      }
    </style>
  </head>
  <body>
    <h2 style="text-align:center;">AI Email Chatbot</h2>
    <div id="chatBox">
      <div id="chatLog"></div>
      <input id="chatInput" type="text" placeholder="Type your response..." />
      <button id="sendBtn" onclick="handleChat()">Send</button>
    </div>

    <script>
      let step = 0;
      let emailTopic = "";
      let recipientName = "";
      let recipientEmail = "";
      let generatedEmail = "";

      const chatLog = document.getElementById("chatLog");
      const chatInput = document.getElementById("chatInput");

      window.onload = () => {
        appendBot("Hi! What should the email be about?");
      };

      function appendBot(text) {
        chatLog.innerHTML += `<p class="bot"><strong>Bot:</strong> ${text}</p>`;
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function appendUser(text) {
        chatLog.innerHTML += `<p class="user"><strong>You:</strong> ${text}</p>`;
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      async function handleChat() {
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;

        appendUser(userMessage);
        chatInput.value = "";

        if (step === 0) {
          emailTopic = userMessage;
          appendBot("Who is this email to?");
          step++;
        } else if (step === 1) {
          recipientName = userMessage;
          appendBot("What is their email address?");
          step++;
        } else if (step === 2) {
          recipientEmail = userMessage;
          appendBot("Generating your email...");

          const response = await fetch("https://eohvq9npo15bpwz.m.pipedream.net", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt: emailTopic,
              recipient: recipientName,
              email: recipientEmail
            })
          });

          const data = await response.json();
          generatedEmail = data.emailBody || "Error: no content returned";
          appendBot("Here’s your email draft:");
          appendBot(`<i>${generatedEmail}</i>`);
          appendBot("Would you like me to send it? (yes/no)");
          step++;
        } else if (step === 3) {
          if (userMessage.toLowerCase().includes("yes")) {
            appendBot("Email sent! ✅");
          } else {
            appendBot("Email not sent. Let me know if you'd like to revise.");
          }
          step++;
        }
      }
    </script>
  </body>
</html>
