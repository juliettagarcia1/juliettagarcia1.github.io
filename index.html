<!DOCTYPE html>
<html>
<head>
  <title>Email Assistant Chat</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #chatbox { border: 1px solid #ccc; padding: 10px; width: 100%; max-width: 600px; height: 400px; overflow-y: auto; margin-bottom: 10px; }
    .user { text-align: right; }
    .bot { text-align: left; }
    .msg { margin: 5px 0; }
    #inputArea { display: flex; gap: 10px; }
    input[type="text"] { flex: 1; padding: 8px; }
  </style>
</head>
<body>
  <h2>Talk to Your AI Assistant</h2>
  <div id="chatbox"></div>
  <div id="inputArea">
    <input type="text" id="input" placeholder="Type your response...">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    let chat = [];
    let stage = 0;
    let emailDraft = "";
    let userData = {};

    function appendMessage(text, sender = 'bot') {
      const chatbox = document.getElementById('chatbox');
      const div = document.createElement('div');
      div.className = `msg ${sender}`;
      div.textContent = text;
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById('input');
      const text = input.value.trim();
      if (!text) return;

      appendMessage(text, 'user');
      input.value = '';
      handleConversation(text);
    }

    async function handleConversation(userMsg) {
      if (stage === 0) {
        appendMessage("Who is the recipient of your email?");
        stage = 1;
      } else if (stage === 1) {
        userData.name = userMsg;
        appendMessage("What is the recipient's email?");
        stage = 2;
      } else if (stage === 2) {
        userData.email = userMsg;
        appendMessage("What is the topic of the email?");
        stage = 3;
      } else if (stage === 3) {
        userData.topic = userMsg;
        appendMessage("Generating your email...");
        const res = await fetch('https://eo4dbpcdj6t17aj.m.pipedream.net', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData)
        });
        const data = await res.json();
        emailDraft = data.generated_email;
        appendMessage("Here's the drafted email:\n\n" + emailDraft);
        appendMessage("Would you like to send this email? (yes or no)");
        stage = 4;
      } else if (stage === 4) {
        if (userMsg.toLowerCase() === 'yes') {
          appendMessage("Sending your email...");
          const res = await fetch('https://eo4dbpcdj6t17aj.m.pipedream.net', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ...userData, body: emailDraft })
          });
          const result = await res.json();
          appendMessage(result.message || "Email sent successfully.");
          stage = 5;
        } else {
          appendMessage("Okay, the email was not sent.");
          stage = 5;
        }
      }
    }

    // Start the conversation
    window.onload = () => {
